<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OptimoRoute - Route Optimizer</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Leaflet Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <link rel="stylesheet" href="templates.css" />
</head>
<body>
    <!-- Top Navigation -->
    <nav class="top-nav ">
        <div class="nav-brand">
            <i class="fas fa-route"></i>
            KMKC
        </div>

        <div class="nav-right">
            <div class="nav-buttons">
                <button class="nav-btn">
                <i class="fas fa-user-plus"></i> Add Customer
            </button>
                <button class="nav-btn">
                    <i class="fas fa-play"></i> Get started
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Left Sidebar -->
       <div class="sidebar">
            <div class="sidebar-header">
                <div class="planning-section">
                    <h5 class="mb-0">
                        <i class="fas fa-calendar-alt"></i> Plan and Optimize
                    </h5>
                </div>

                <div class="action-buttons">
                    <button class="btn-primary" onclick="optimizeRoutes()">
                        <i class="fas fa-magic"></i> Optimize
                    </button>
                    <button class="btn-outline" onclick="switchView()">
                        <i class="fas fa-exchange-alt"></i> Switch
                    </button>
                    <button class="btn-outline" onclick="reverseRoutes()">
                        <i class="fas fa-undo"></i> Reverse
                    </button>
                </div>
                <div class="mb-3">
                    <button class="btn-outline me-2" onclick="copyRoutes()">
                        <i class="fas fa-copy"></i> Copy
                    </button>
                    <input type="checkbox" id="unschedule" class="me-1">
                    <label for="unschedule" style="font-size: 0.875rem;">Unschedule</label>
                </div>
            </div>

            <div class="drivers-section">
                <h6 class="mb-3 px-2">
                    <i class="fas fa-truck"></i> Driver

                    <span id="driver-count-badge" class="badge bg-primary rounded-pill ms-2">
                        0 drivers
                    </span>
                </h6>

                <div id="driver-list-container">
                    <p style="padding: 0.75rem; color: var(--secondary-color);">Đang tải danh sách tài xế...</p>
                </div>
            </div>

            <div class="p-3 border-top">
                <button class="btn-outline w-100" onclick="hideDrivers()">
                    <i class="fas fa-eye-slash"></i> Hide Drivers
                </button>
            </div>
        </div>

        <!-- Map Container -->
        <div class="map-container">
            <div id="map"></div>

            <!-- Map Controls -->
            <div class="map-controls">
                <button class="control-btn" onclick="centerMap()" title="Center Map">
                    <i class="fas fa-crosshairs"></i>
                </button>
                <button class="control-btn" onclick="zoomIn()" title="Zoom In">
                    <i class="fas fa-plus"></i>
                </button>
                <button class="control-btn" onclick="zoomOut()" title="Zoom Out">
                    <i class="fas fa-minus"></i>
                </button>
                <button class="control-btn" onclick="toggleSatellite()" title="Satellite View">
                    <i class="fas fa-satellite"></i>
                </button>
                <button class="control-btn" onclick="toggleTraffic()" title="Traffic">
                    <i class="fas fa-car"></i>
                </button>
                <button class="control-btn" onclick="exportMap()" title="Export">
                    <i class="fas fa-download"></i>
                </button>
                <button class="control-btn" onclick="fullScreen()" title="Full Screen">
                    <i class="fas fa-expand"></i>
                </button>
            </div>

            <!-- Bottom Panel -->
            <div class="bottom-panel border-top bg-light">
                  <div class="d-flex justify-content-between align-items-center p-2">

                    <!-- Tabs -->
                    <ul class="nav nav-tabs" id="panelTabs">
                      <li class="nav-item">
                        <a class="nav-link active" href="#" onclick="switchTab(this, 'orders')">
                          <i class="fas fa-list"></i> Orders
                        </a>
                      </li>
                      <li class="nav-item">
                        <a class="nav-link" href="#" onclick="switchTab(this, 'routes')">
                          <i class="fas fa-route"></i> Routes
                        </a>
                      </li>
                      <li class="nav-item">
                        <a class="nav-link" href="#" onclick="switchTab(this, 'timeline')">
                          <i class="fas fa-clock"></i> Timeline
                        </a>
                      </li>
                      <li class="nav-item">
                        <a class="nav-link" href="#" onclick="switchTab(this, 'not-scheduled')">
                          <i class="fas fa-exclamation-triangle"></i> Not Scheduled
                        </a>
                      </li>
                    </ul>


                    <div class="d-flex align-items-center">
                          <input type="date" value="2025-09-27" class="form-control form-control-sm me-2" style="width: 150px;">
                          <button class="btn btn-primary btn-sm me-2" onclick="importOrders()">
                            <i class="fas fa-upload"></i> Import Orders
                          </button>
                          <button class="btn btn-success btn-sm me-2" onclick="optimizeRoutes()">
                            <i class="fas fa-route"></i> Plan Routes
                          </button>
                          <button class="btn btn-outline-secondary btn-sm" onclick="shareRoutes()">
                            <i class="fas fa-share"></i> Share Routes
                          </button>
                          <button class="btn btn-link ms-2" onclick="toggleBottomPanel()" title="Toggle Panel">
                            <i class="fas fa-chevron-down"></i>
                          </button>
                    </div>
                </div>

                <div class="panel-content">
                    <table class="orders-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" onchange="selectAllOrders(this)"></th>
                                <th>Order ID</th>
                                <th>Priority</th>
                                <th>Location</th>
                                <th>Address</th>
                                <th>Rescheduled order from</th>
                                <th>Rescheduled to</th>
                                <th>Weight [kg]</th>
                                <th>Volume [m3]</th>
                                <th>Duration</th>
                                <th>Time windows</th>
                                <th>Skills</th>
                                <th>Vehicle features</th>
                            </tr>
                        </thead>
                        <tbody id="orders-tbody">
                            <!-- Orders will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification" style="display: none;">
        <i class="fas fa-check-circle"></i>
        <span id="notification-text">Routes have been planned</span>
        <button onclick="hideNotification()" style="background: none; border: none; color: white; margin-left: 1rem;">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <!-- Loading -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div>Optimizing routes...</div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // Initialize map
        let map;
        let markers = [];
        let routes = [];
        let currentTab = 'orders';

        // Sample orders data
        const ordersData = [
            // { id: 'ORD001', priority: 'high', location: 'Highlands Coffee', address: 'Mac Dinh Chi', weight: 5, volume: 1, duration: '4 min', driver: 'Driver 001' },
            // { id: 'ORD002', priority: 'medium', location: 'Ca Phe Juicy', address: '', weight: 5, volume: 1, duration: '5 min', driver: 'Driver 002' },
            // { id: 'ORD003', priority: 'medium', location: 'Loteria', address: '11BIS Nguyen Thi Minh Khai', weight: 5, volume: 1, duration: '3 min', driver: 'Driver 003' },
            // { id: 'ORD004', priority: 'medium', location: 'Ca Phe Smart', address: '9 Dinh Tien Hoang', weight: 5, volume: 1, duration: '10 min', driver: 'Driver 004' },
            // { id: 'ORD005', priority: 'medium', location: 'Ca Phe Cuoc Song Dep', address: '10A Pham Ngoc Thach', weight: 5, volume: 1, duration: '7 min', driver: 'Driver 001' },
            // { id: 'ORD006', priority: 'medium', location: 'Ca Phe Regina', address: '', weight: 5, volume: 1, duration: '9 min', driver: 'Driver 002' },
            // { id: 'ORD007', priority: 'medium', location: 'Nha Hang Soya Pudding', address: '172 Bui Thi Xuan', weight: 5, volume: 1, duration: '4 min', driver: 'Driver 003' },
        ];

        // Initialize map when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            populateOrdersTable();
            showNotification('Routes have been planned. Undo changes');

            loadAndDisplayDrivers();
        });

        function initMap() {
            // Initialize Leaflet map centered on Ho Chi Minh City
            map = L.map('map').setView([10.8231, 106.6297], 12);

            // Add tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors | <a href="https://www.mapbox.com/">MapBox Streets</a>'
            }).addTo(map);

            // Đọc file JSON
            // 1️⃣ Tạo icon riêng cho depot (màu xanh dương)
            const depotIcon = L.icon({
              iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
              shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
              iconSize: [25, 41],
              iconAnchor: [12, 41],
              popupAnchor: [1, -34],
              shadowSize: [41, 41]
            });

            // 2️⃣ Tạo icon riêng cho customer (màu đỏ)
            const customerIcon = L.icon({
              iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
              shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
              iconSize: [25, 41],
              iconAnchor: [12, 41],
              popupAnchor: [1, -34],
              shadowSize: [41, 41]
            });

            // 3️⃣ Load depot markers (màu xanh)
            fetch("../data/depots.json")
              .then(response => response.json())
              .then(data => {
                data.forEach(depot => {
                  const marker = L.marker([depot.latitude, depot.longitude], { icon: depotIcon }).addTo(map);
                  marker.bindPopup(`<b>${depot.name}</b><br>Lat: ${depot.latitude}<br>Lon: ${depot.longitude}`);
                });
              })
              .catch(error => console.error("Lỗi tải JSON depot:", error));

            // 4️⃣ Load customer markers (màu đỏ)
            fetch("../data/customers.json")
              .then(response => response.json())
              .then(data => {
                data.forEach(order => {
                  const marker = L.marker([order.latitude, order.longitude], { icon: customerIcon }).addTo(map);
                  marker.bindPopup(`<b>${order.name}</b><br>Lat: ${order.latitude}<br>Lon: ${order.longitude}`);
                });
              })
              .catch(error => console.error("Lỗi tải JSON customer:", error));

        }

        // Toggle bottom panel
        function toggleBottomPanel() {
            const panel = document.querySelector('.bottom-panel');
            panel.classList.toggle('collapsed');
        }



        // Tab switching
        function switchTab(tabElement, tabName) {
            // Remove active class from all tabs
            document.querySelectorAll('.panel-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Add active class to clicked tab
            tabElement.classList.add('active');
            currentTab = tabName;

            // Update content based on tab
            updatePanelContent(tabName);
        }

        function updatePanelContent(tabName) {
            const tbody = document.getElementById('orders-tbody');

            if (tabName === 'orders') {
                populateOrdersTable();
            } else if (tabName === 'routes') {
                tbody.innerHTML = '<tr><td colspan="13" class="text-center py-4">Routes information will be displayed here</td></tr>';
            } else if (tabName === 'timeline') {
                tbody.innerHTML = '<tr><td colspan="13" class="text-center py-4">Timeline view will be displayed here</td></tr>';
            } else if (tabName === 'not-scheduled') {
                tbody.innerHTML = '<tr><td colspan="13" class="text-center py-4">Unscheduled orders will be displayed here</td></tr>';
            }
        }

        function populateOrdersTable() {
            const tbody = document.getElementById('orders-tbody');
            tbody.innerHTML = '';

            // đoạn này thêm dữ liệu
            ordersData.forEach((order, index) => {
                const priorityClass = `priority-${order.priority}`;
                const row = `
                    <tr>
                        <td><input type="checkbox" class="order-checkbox"></td>
                        <td><strong>${order.id}</strong></td>
                        <td><span class="order-priority ${priorityClass}"></span>${order.priority.charAt(0).toUpperCase() + order.priority.slice(1)}</td>
                        <td>${order.location}</td>
                        <td>${order.address}</td>
                        <td>-</td>
                        <td>-</td>
                        <td>${order.weight}</td>
                        <td>${order.volume}</td>
                        <td>${order.duration}</td>
                        <td>-</td>
                        <td>-</td>
                        <td>-</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // Driver functions
        function toggleDriver(element, driverId) {
            const checkbox = element.querySelector('.driver-checkbox');
            checkbox.checked = !checkbox.checked;

            if (checkbox.checked) {
                element.classList.add('selected');
            } else {
                element.classList.remove('selected');
            }

            updateSelectedDriversCount();
        }

        // Map functions
        function centerMap() {
            map.setView([10.8231, 106.6297], 12);
        }

        function zoomIn() {
            map.zoomIn();
        }

        function zoomOut() {
            map.zoomOut();
        }

        function toggleSatellite() {
            // Toggle between normal and satellite view
            const currentLayer = map._layers[Object.keys(map._layers)[0]];
            map.removeLayer(currentLayer);

            if (currentLayer._url.includes('openstreetmap')) {
                // Switch to satellite
                L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: 'Tiles © Esri'
                }).addTo(map);
            } else {
                // Switch to normal
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors'
                }).addTo(map);
            }
        }

        function toggleTraffic() {
            showNotification('Traffic layer toggled');
        }

        function exportMap() {
            showNotification('Map exported successfully');
        }

        function fullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        // Action functions
        async function optimizeRoutes() {
          showLoading();
          try {
            const response = await fetch("http://127.0.0.1:8000/api/calculate/", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                num_vehicles_per_depot: 2
              })
            });

            const result = await response.json();
            hideLoading();

            if (result.status === "success") {
              showNotification("Routes optimized successfully!", "success");
              console.log("Kết quả:", result);

              const routes = result.best.routes
              // Có thể render routes lên map ở đây
              // ==========================
              //  Xóa polyline cũ (nếu có)
              // ==========================
              if (window.currentPolylines) {
                window.currentPolylines.forEach(line => map.removeLayer(line));
              }
              window.currentPolylines = [];

              // ==========================
              // Vẽ route mới
              // ==========================
              const colors = ["#e6194b", "#3cb44b", "#ffe119", "#0082c8", "#f58231", "#911eb4", "#46f0f0"];

              routes.forEach((routeObj, idx) => {

                const rawCoords = routeObj.route || routeObj.path || routeObj.coordinates;
                if (!rawCoords || rawCoords.length === 0) return;

                // Chuẩn hóa về [lat, lng]
                const routeCoords = rawCoords.map(p => [p.lat || p.latitude, p.lng || p.longitude]);

                // Vẽ polyline
                const polyline = L.polyline(routeCoords, {
                  color: colors[idx % colors.length],
                  weight: 5,
                  opacity: 0.8,
                }).addTo(map);

                // Lưu lại để sau xóa
                window.currentPolylines.push(polyline);

                // Fit bản đồ theo route đầu tiên
                if (idx === 0) map.fitBounds(polyline.getBounds());

                // Thêm marker bắt đầu và kết thúc
                const start = routeCoords[0];
                const end = routeCoords[routeCoords.length - 1];

                L.marker(start).addTo(map).bindPopup(`🚚 Route ${idx + 1} Start`);
                L.marker(end).addTo(map).bindPopup(`🏁 Route ${idx + 1} End`);
              });
            } else {
              showNotification(result.message || "No solution found!", "error");
            }

          } catch (error) {
            hideLoading();
            console.error("Error:", error);
            showNotification("Error while optimizing routes!", "error");
          }
        }

        function switchView() {
            showNotification('View switched');
        }

        function reverseRoutes() {
            showNotification('Routes reversed');
        }

        function copyRoutes() {
            showNotification('Routes copied to clipboard');
        }

        function hideDrivers() {
            const driversSection = document.querySelector('.drivers-section');
            driversSection.style.display = driversSection.style.display === 'none' ? 'block' : 'none';
        }

        function importOrders() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.csv,.xlsx,.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    showNotification(`Importing ${file.name}...`);
                    setTimeout(() => {
                        showNotification('Orders imported successfully!', 'success');
                    }, 2000);
                }
            };
            input.click();
        }

        function planRoutes() {
            showLoading();

            setTimeout(() => {
                hideLoading();
                showNotification('Routes planned successfully!', 'success');
            }, 2500);
        }

        function shareRoutes() {
            if (navigator.share) {
                navigator.share({
                    title: 'Route Optimization Results',
                    text: 'Check out these optimized routes!',
                    url: window.location.href
                });
            } else {
                // Fallback - copy to clipboard
                navigator.clipboard.writeText(window.location.href);
                showNotification('Link copied to clipboard!');
            }
        }

        function selectAllOrders(checkbox) {
            const orderCheckboxes = document.querySelectorAll('.order-checkbox');
            orderCheckboxes.forEach(cb => {
                cb.checked = checkbox.checked;
            });
        }

        function viewOrderDetails(orderIndex) {
            const order = ordersData[orderIndex];
            alert(`Order Details:\n\nID: ${order.id}\nLocation: ${order.location}\nAddress: ${order.address}\nPriority: ${order.priority}\nWeight: ${order.weight}kg\nVolume: ${order.volume}m³\nDuration: ${order.duration}`);
        }

        // Utility functions
        function showNotification(message, type = 'default') {
            const notification = document.getElementById('notification');
            const text = document.getElementById('notification-text');

            text.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'flex';

            setTimeout(() => {
                hideNotification();
            }, 5000);
        }

        function hideNotification() {
            document.getElementById('notification').style.display = 'none';
        }

        function showLoading() {
            document.getElementById('loading').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        /**
         * Tải dữ liệu từ file 'data/drivers.json' và hiển thị lên giao diện
         */
        async function loadAndDisplayDrivers() {
            // Lấy "vùng chứa" (bạn cần đảm bảo div này tồn tại trong HTML)
            const driverListContainer = document.getElementById('driver-list-container');
            // Lấy cái badge đếm số lượng
            const driverCountBadge = document.getElementById('driver-count-badge');

            if (!driverListContainer) {
                console.error("Lỗi: Không tìm thấy thẻ div với id='driver-list-container'.");
                return;
            }

            try {
                // 1. Lấy dữ liệu từ file JSON
                const response = await fetch('../data/drivers.json');
                if (!response.ok) {
                    throw new Error(`Lỗi HTTP: ${response.status}`);
                }

                // 2. Chuyển đổi dữ liệu từ text sang mảng JavaScript
                const drivers = await response.json();

                // Xóa dòng chữ "Đang tải..."
                driverListContainer.innerHTML = '';

                // Mảng màu để gán xoay vòng cho tài xế
                const colors = ['#ef4444', '#f97316', '#22c55e', '#0bd2f5', '#6b7280'];

                // 3. Lặp qua TỪNG tài xế trong file JSON
                drivers.forEach((driver, index) => {

                    const color = colors[index % colors.length];

                    // Tạo một thẻ div mới cho mỗi tài xế
                    const driverItem = document.createElement('div');
                    driverItem.className = 'driver-item'; // Gán class CSS y như cũ

                    // Gán sự kiện onclick cho thẻ div này
                    driverItem.onclick = function() {
                        // Chúng ta sẽ dùng lại hàm toggleDriver bạn đã có
                        toggleDriver(driverItem, driver.id);
                    };

                    // 4. Tạo nội dung HTML bên trong, sử dụng dữ liệu từ file JSON
                    driverItem.innerHTML = `
                    <input type="checkbox" class="driver-checkbox">
                    <div class="driver-color" style="background-color: ${color};"></div>
                    <div class="driver-info">
                        <div class="driver-name">${driver.name} (ID: ${driver.id})</div>

                        <div class="driver-contact-info">
                            <span><i class="fas fa-phone-alt"></i> ${driver.phone}</span>
                            <span><i class="fas fa-warehouse"></i> Kho: ${driver.depot_id}</span>
                        </div>

                        <div class="driver-stats">
                            <span class="text-muted">Unassigned</span>
                        </div>
                    </div>
                `;
                    // 5. Thêm tài xế vừa tạo vào "vùng chứa"
                    driverListContainer.appendChild(driverItem);
                });

                // 6. Cập nhật lại số lượng tài xế trên badge
                if (driverCountBadge) {
                    driverCountBadge.textContent = `${drivers.length} drivers`;
                }

            } catch (error) {
                console.error("Lỗi không thể tải file drivers.json:", error);
                driverListContainer.innerHTML = '<p style="color: red; padding: 0.75rem;">Không thể tải danh sách tài xế.</p>';
            }
        }

        function updateSelectedDriversCount() {
            const selectedCount = document.querySelectorAll('.driver-checkbox:checked').length;
            const driverCountBadge = document.getElementById('driver-count-badge');
            if (driverCountBadge) {
                driverCountBadge.textContent = `${selectedCount} drivers selected`;
            }
        }

        // Map resize handler
        window.addEventListener('resize', function() {
            if (map) {
                setTimeout(() => {
                    map.invalidateSize();
                }, 100);
            }
        });
    </script>
</body>
</html>